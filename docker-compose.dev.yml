version: "3.9"

services:
  db:
    image: mysql:8.0
    container_name: simmer_db_dev
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: simmer_db_despliegue
      MYSQL_USER: simmer
      MYSQL_PASSWORD: simmer_password
    ports:
      - "3306:3306" # opcional exponer al host
    volumes:
      - db_data_dev:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u$${MYSQL_USER} -p$${MYSQL_PASSWORD} --silent"]
      interval: 5s
      timeout: 5s
      retries: 30

  mosquitto:
    image: eclipse-mosquitto:2
    container_name: simmer_mosquitto_dev
    restart: always
    ports:
      - "1883:1883"  # Puerto MQTT
      - "9001:9001"  # Puerto WebSocket (opcional, por si lo necesitas después)
    volumes:
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - mosquitto_data_dev:/mosquitto/data
      - mosquitto_logs_dev:/mosquitto/log

  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    container_name: simmer_app_dev
    restart: always
    env_file:
      - .env.docker               # << usamos host db:3306 aquí
    ports:
      - "3000:3000"
    depends_on:
      db:
        condition: service_healthy
      mosquitto:
        condition: service_started
    volumes:
      - .:/app                    # hot reload
      - /app/node_modules         # evita que el node_modules del host tape al del contenedor
    # Ejecuta migraciones y luego el seed (idempotente) antes de levantar Next.js
    command: sh -c "npx prisma migrate dev && npx prisma db seed && npm run dev"
    environment:
      CHOKIDAR_USEPOLLING: "true" # ayuda en Windows/OneDrive
      WATCHPACK_POLLING: "true"
      MQTT_BROKER_URL: "mqtt://mosquitto:1883"  # URL interna del broker

volumes:
  db_data_dev:
  mosquitto_data_dev:
  mosquitto_logs_dev:
