version: "3.9"

services:
  db:
    image: mysql:8.0
    container_name: simmer_db_dev
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: simmer_db_despliegue
      MYSQL_USER: simmer
      MYSQL_PASSWORD: simmer_password
    ports:
      - "3306:3306" # opcional exponer al host
    volumes:
      - db_data_dev:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u$${MYSQL_USER} -p$${MYSQL_PASSWORD} --silent"]
      interval: 5s
      timeout: 5s
      retries: 30

  mqtt:
    image: eclipse-mosquitto:2
    container_name: simmer_mqtt_dev
    restart: always
    ports:
      - "1883:1883"   # MQTT TCP (broker)
      - "9001:9001"   # MQTT sobre WebSocket (para pruebas/front)
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log

  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    container_name: simmer_app_dev
    restart: always
    env_file:
      - .env.docker               # << usamos host db:3306 aquÃ­
    ports:
      - "3000:3000"
    depends_on:
      db:
        condition: service_healthy
      mqtt:
        condition: service_started
    volumes:
      - .:/app                    # hot reload
      - /app/node_modules         # evita que el node_modules del host tape al del contenedor
    command: sh -c "npx prisma migrate dev && npm run dev"
    environment:
      CHOKIDAR_USEPOLLING: "true" # ayuda en Windows/OneDrive
      WATCHPACK_POLLING: "true"

volumes:
  db_data_dev:
