// generator y datasource
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "mysql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

// --- Enums ---
enum Role {
  operator
  labManager
  admin
}

enum CategoriaUnidad {
  temperatura
  presion
  volumen
  masa
  tiempo
  velocidad
  concentracion
  pH
  flujo
  frecuencia
  porcentaje
  otra
}

// --- Usuario / Perfil ---
model UserMetadata {
  id        String   @id @default(uuid())
  nombre    String
  apellido  String
  tipo      Role     @default(operator)
  email     String
  password  String
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // registros de actuadores que hizo este usuario
  registrosActuador RegistroActuador[]

  @@unique([email, activo])
  @@index([tipo])
  @@index([createdAt])
  @@index([activo])
}

// --- Sensores / Actuadores / Proyectos ---

model UnidadMedida {
  id        Int             @id @default(autoincrement())
  nombre    String // ej: "Grados Celsius"
  simbolo   String          // ej: "°C"
  categoria CategoriaUnidad
  activo    Boolean         @default(true)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  sensores   Sensor[]
  actuadores Actuador[]

  @@index([activo])
  @@index([categoria])
}

model Sensor {
  sensor_id        Int          @id @default(autoincrement())
  nombre           String
  descripcion      String?
  unidad_medida_id Int
  unidadMedida     UnidadMedida @relation(fields: [unidad_medida_id], references: [id])
  valor_max        Float
  valor_min        Float
  estado           Boolean      @default(true)
  fuente_datos     String?

  // Relación N:M con proyectos a través de ProyectoSensor
  proyectos ProyectoSensor[]

  // Ya no cuelgan mediciones directamente del sensor

  activo    Boolean  @default(true) // <- soft-delete
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([nombre])
  @@index([activo])
  @@index([unidad_medida_id])
}

model Actuador {
  actuator_id      Int          @id @default(autoincrement())
  nombre           String
  descripcion      String?
  unidad_medida_id Int
  unidadMedida     UnidadMedida @relation(fields: [unidad_medida_id], references: [id])
  valor_max        Float
  valor_min        Float
  estado           Boolean      @default(true)
  fuente_datos     String?

  // Relación N:M con proyectos a través de ProyectoActuador
  proyectos ProyectoActuador[]

  // Ya no cuelgan registros directamente del actuador

  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([nombre])
  @@index([activo])
  @@index([unidad_medida_id]) // ← índice para la FK
}

model Proyecto {
  project_id  Int     @id @default(autoincrement())
  nombre      String
  descripcion String?

  sensores   ProyectoSensor[]
  actuadores ProyectoActuador[]

  estado    Boolean  @default(true)
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([nombre])
  @@index([activo])
}

// --- Tablas pivote (N:M) ---
// Ahora las pivotes tienen su propio id y son dueñas de mediciones/registros

model ProyectoSensor {
  id         Int @id @default(autoincrement())

  proyectoId Int
  sensorId   Int

  proyecto Proyecto @relation(fields: [proyectoId], references: [project_id], onDelete: Cascade, onUpdate: Cascade)
  sensor   Sensor   @relation(fields: [sensorId], references: [sensor_id], onDelete: Cascade, onUpdate: Cascade)

  mediciones MedicionSensor[]

  @@unique([proyectoId, sensorId]) // mismo sensor no se repite en el mismo proyecto
  @@index([sensorId])
}

model ProyectoActuador {
  id         Int @id @default(autoincrement())

  proyectoId Int
  actuadorId Int

  proyecto Proyecto @relation(fields: [proyectoId], references: [project_id], onDelete: Cascade, onUpdate: Cascade)
  actuador Actuador @relation(fields: [actuadorId], references: [actuator_id], onDelete: Cascade, onUpdate: Cascade)

  registros RegistroActuador[]

  @@unique([proyectoId, actuadorId])
  @@index([actuadorId])
}

// --- Lecturas / Registros ---
// Cada medición/regsitro pertenece a un vínculo Proyecto–Sensor / Proyecto–Actuador

model MedicionSensor {
  id               Int @id @default(autoincrement())
  proyectoSensorId Int

  proyectoSensor ProyectoSensor @relation(fields: [proyectoSensorId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  valor     Float
  timestamp DateTime @default(now())

  @@index([proyectoSensorId])
  @@index([timestamp])
}

model RegistroActuador {
  id                 Int @id @default(autoincrement())
  proyectoActuadorId Int

  proyectoActuador ProyectoActuador @relation(fields: [proyectoActuadorId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  valor     Float
  timestamp DateTime @default(now())

  // quién hizo el envío
  usuarioId String?
  usuario   UserMetadata? @relation(fields: [usuarioId], references: [id])

  @@index([proyectoActuadorId])
  @@index([timestamp])
  @@index([usuarioId])
}

model PasswordReset {
  id        String   @id @default(uuid())
  email     String
  code      String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([code])
  @@index([expiresAt])
}