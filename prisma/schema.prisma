// generator y datasource
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "mysql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

// --- Enums ---
enum Role {
  operator
  labManager
  admin
}

enum CategoriaUnidad {
  temperatura
  presion
  volumen
  masa
  tiempo
  velocidad
  concentracion
  pH
  flujo
  frecuencia
  porcentaje
  otra
}

// --- Usuario / Perfil ---
model UserMetadata {
  id        String   @id @default(uuid())
  nombre    String
  apellido  String
  tipo      Role     @default(operator)
  email     String // <- quitamos @unique para permitir duplicado cuando uno está inactivo
  password  String
  activo    Boolean  @default(true) // <- soft-delete
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([email, activo]) // permite reutilizar email si el anterior quedó inactivo
  @@index([tipo])
  @@index([createdAt])
  @@index([activo])
}

// --- Sensores / Actuadores / Proyectos ---

model UnidadMedida {
  id        Int             @id @default(autoincrement())
  nombre    String // ej: "Grados Celsius"
  simbolo   String          // ej: "°C"
  categoria CategoriaUnidad
  activo    Boolean         @default(true)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  sensores   Sensor[]
  actuadores Actuador[]

  @@index([activo])
  @@index([categoria])
}

model Sensor {
  sensor_id        Int          @id @default(autoincrement())
  nombre           String
  descripcion      String?
  unidad_medida_id Int
  unidadMedida     UnidadMedida @relation(fields: [unidad_medida_id], references: [id])
  valor_max        Float
  valor_min        Float
  estado           Boolean      @default(true)
  fuente_datos     String?

  proyectos  ProyectoSensor[]
  mediciones MedicionSensor[]

  activo    Boolean  @default(true) // <- soft-delete
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([nombre])
  @@index([activo])
  @@index([unidad_medida_id])
}

model Actuador {
  actuator_id      Int          @id @default(autoincrement())
  nombre           String
  descripcion      String?
  unidad_medida_id Int
  unidadMedida     UnidadMedida @relation(fields: [unidad_medida_id], references: [id])
  valor_max        Float
  valor_min        Float
  estado           Boolean      @default(true)
  fuente_datos     String?

  proyectos ProyectoActuador[]
  registros RegistroActuador[]

  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([nombre])
  @@index([activo])
  @@index([unidad_medida_id]) // ← índice para la FK
}

model Proyecto {
  project_id  Int     @id @default(autoincrement())
  nombre      String
  descripcion String?

  sensores   ProyectoSensor[]
  actuadores ProyectoActuador[]

  estado    Boolean  @default(true)
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([nombre])
  @@index([activo])
}

// --- Tablas pivote (N:M) ---

model ProyectoSensor {
  proyecto   Proyecto @relation(fields: [proyectoId], references: [project_id], onDelete: Cascade, onUpdate: Cascade)
  proyectoId Int

  sensor   Sensor @relation(fields: [sensorId], references: [sensor_id], onDelete: Cascade, onUpdate: Cascade)
  sensorId Int

  // Back-rel con la unión de mediciones N:M
  medicionesProyecto ProyectoMedicion[] @relation("ProyectoSensor_to_ProyectoMedicion")

  @@id([proyectoId, sensorId])
  @@index([sensorId])
}

model ProyectoActuador {
  proyecto   Proyecto @relation(fields: [proyectoId], references: [project_id], onDelete: Cascade, onUpdate: Cascade)
  proyectoId Int

  actuador   Actuador @relation(fields: [actuadorId], references: [actuator_id], onDelete: Cascade, onUpdate: Cascade)
  actuadorId Int

  // Back-rel con la unión de registros N:M
  registrosProyecto ProyectoRegistro[] @relation("ProyectoActuador_to_ProyectoRegistro")

  @@id([proyectoId, actuadorId])
  @@index([actuadorId])
}

// --- Lecturas / Registros ---

model MedicionSensor {
  id        Int      @id @default(autoincrement())
  sensor    Sensor   @relation(fields: [sensorId], references: [sensor_id], onDelete: Cascade, onUpdate: Cascade)
  sensorId  Int
  valor     Float
  timestamp DateTime @default(now())

  // Back-rel a la unión N:M con proyectos
  proyectos ProyectoMedicion[] @relation("MedicionSensor_to_ProyectoMedicion")

  // Necesario para FK compuesta desde ProyectoMedicion
  @@unique([id, sensorId])
  @@index([sensorId])
  @@index([timestamp])
}

model RegistroActuador {
  id         Int      @id @default(autoincrement())
  actuador   Actuador @relation(fields: [actuadorId], references: [actuator_id], onDelete: Cascade, onUpdate: Cascade)
  actuadorId Int
  valor      Float
  timestamp  DateTime @default(now())

  // Back-rel a la unión N:M con proyectos
  proyectos ProyectoRegistro[] @relation("RegistroActuador_to_ProyectoRegistro")

  // Necesario para FK compuesta desde ProyectoRegistro
  @@unique([id, actuadorId])
  @@index([actuadorId])
  @@index([timestamp])
}

// --- NUEVAS tablas de unión N:M con integridad ---

model ProyectoMedicion {
  // Claves
  proyectoId Int
  sensorId   Int
  medicionId Int

  // (proyecto, sensor) válido
  proyectoSensor ProyectoSensor @relation("ProyectoSensor_to_ProyectoMedicion", fields: [proyectoId, sensorId], references: [proyectoId, sensorId], onDelete: Restrict, onUpdate: Cascade)

  // medición perteneciente al mismo sensor
  medicion MedicionSensor @relation("MedicionSensor_to_ProyectoMedicion", fields: [medicionId, sensorId], references: [id, sensorId], onDelete: Cascade, onUpdate: Cascade)

  // Evita duplicar el mismo vínculo dentro de un proyecto
  @@id([proyectoId, medicionId])
  @@index([sensorId])
  @@index([medicionId])
}

model ProyectoRegistro {
  // Claves
  proyectoId Int
  actuadorId Int
  registroId Int

  // (proyecto, actuador) válido
  proyectoActuador ProyectoActuador @relation("ProyectoActuador_to_ProyectoRegistro", fields: [proyectoId, actuadorId], references: [proyectoId, actuadorId], onDelete: Restrict, onUpdate: Cascade)

  // registro perteneciente al mismo actuador
  registro RegistroActuador @relation("RegistroActuador_to_ProyectoRegistro", fields: [registroId, actuadorId], references: [id, actuadorId], onDelete: Cascade, onUpdate: Cascade)

  @@id([proyectoId, registroId])
  @@index([actuadorId])
  @@index([registroId])
}
